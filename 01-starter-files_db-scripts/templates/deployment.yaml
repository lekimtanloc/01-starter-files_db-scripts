apiVersion: apps/v1
kind: Deployment
metadata:
  name: mariadb
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mariadb
  template:
    metadata:
      labels:
        app: mariadb
    spec:
      containers:
        - name: mariadb
          image: "{{ .Values.mariadb.image }}:{{ .Values.mariadb.tag }}"
          env:
            - name: MYSQL_ROOT_PASSWORD
              value: {{ .Values.mariadb.rootPassword | quote }}
            - name: MYSQL_DATABASE
              value: {{ .Values.mariadb.database | quote }}
            - name: MYSQL_USER
              value: {{ .Values.mariadb.user | quote }}
            - name: MYSQL_PASSWORD
              value: {{ .Values.mariadb.password | quote }}

            # üî• IMPORTANT: TURN OFF SSL REQUIREMENT
            - name: MARIADB_DISABLE_SSL
              value: "true"
            - name: MARIADB_TLS_VERSION
              value: "off"

            # Optional nh∆∞ng gi√∫p client kh√¥ng b·∫≠t SSL
            - name: MYSQL_SSL_MODE
              value: "DISABLED"

          ports:
            - containerPort: 3306

          # --- FIXED LIVENESS ---
          livenessProbe:
            exec:
              command:
                - sh
                - -c
                - "mariadb-admin ping -h 127.0.0.1 -uroot -p{{ .Values.mariadb.rootPassword }}"
            initialDelaySeconds: 40
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 5

          # --- FIXED READINESS ---
          readinessProbe:
            exec:
              command:
                - sh
                - -c
                - "mariadb-admin ping -h 127.0.0.1 -uroot -p{{ .Values.mariadb.rootPassword }}"
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 2
            failureThreshold: 5
            successThreshold: 1

          volumeMounts:
            - name: data
              mountPath: /var/lib/mysql

      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: mariadb-pvc
